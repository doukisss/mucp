<?php
//24.0.30.0 WL/COM/Com.php GF
//VersionVI: 01F240077f
//(c) 2006-2008 PC SOFT - Release
 if (!defined('__INC__FMK/Disque.php')) { define('__INC__FMK/Disque.php',true); include_once(WB_INCLUDE_PATH.'WD99bd5984d9c78e9239c729a52b83e562.php'); } if (!defined('__INC__FMK/Chaine.php')) { define('__INC__FMK/Chaine.php',true); include_once(WB_INCLUDE_PATH.'WD55acb2e708e26f23cb8956cd93e98123.php'); } if (!defined('__INC__FMK/Date.php')) { define('__INC__FMK/Date.php',true); include_once(WB_INCLUDE_PATH.'WD97af71f4453b9d548e8ff90b4bbaba9f.php'); } if (!defined('__INC__FMK/Reseau/FTP.php')) { define('__INC__FMK/Reseau/FTP.php',true); include_once(WB_INCLUDE_PATH.'WD93d3cbc6ab325d862a59a47538250678.php'); } if (!defined('__INC__FMK/Reseau/IP.php')) { define('__INC__FMK/Reseau/IP.php',true); include_once(WB_INCLUDE_PATH.'WD88df09c1010f44cbd25d861ff0e0460e.php'); } if (!defined('__INC__FMK/Dependance.php')) { define('__INC__FMK/Dependance.php',true); include_once(WB_INCLUDE_PATH.'WDb98029e1a3f05e7ed504ba0a18a9dea8.php'); } if (!defined('__INC__FMK/Environnement.php')) { define('__INC__FMK/Environnement.php',true); include_once(WB_INCLUDE_PATH.'WD62c1fcbeb97cd284448bd7a6ec627839.php'); } if (!defined('__INC__FMK/Hash.php')) { define('__INC__FMK/Hash.php',true); include_once(WB_INCLUDE_PATH.'WDf11d1f55fc38121769a6f5736c1e5eeb.php'); } if (!defined('__INC__FMK/Disque/Fichier.php')) { define('__INC__FMK/Disque/Fichier.php',true); include_once(WB_INCLUDE_PATH.'WD5e394596c6434eec95aa14dd761a6e59.php'); } define("TypeMIMETexte","text"); define("TypeMIMESeparateur","/"); define("TypeMIMETexteSep",(TypeMIMETexte . TypeMIMESeparateur)); define("TypeMIMEDefaut",(TypeMIMETexteSep . "html")); define("MotCleEnteteContenu","Content-"); define("MotCleEnteteContenuType",MotCleEnteteContenu . "Type"); define("MotCleEnteteSeparateur",": "); define("MotCleEnteteType",(MotCleEnteteContenuType . MotCleEnteteSeparateur)); define("MotCleEnteteSepSuite",";"); define("MotCleEnteteSepValeurSuite","="); define("MotCleEnteteContenuDisposition",(MotCleEnteteContenu. "Disposition")); define("SuiteEnteteAttachement",("attachment". MotCleEnteteSepSuite . "filename" . MotCleEnteteSepValeurSuite)); define("MotCleEnteteAttachement",(MotCleEnteteContenuDisposition . MotCleEnteteSeparateur . SuiteEnteteAttachement)); define("MotCleEnteteSepValeurLiteralSuite","\""); define("ISO_8859_1","iso-8859-1"); define("UTF_8","UTF-8"); define("TypeMIMECharsetISO_8859_1",(MotCleEnteteSepSuite . "charset" . MotCleEnteteSepValeurSuite . MotCleEnteteSepValeurLiteralSuite . ISO_8859_1 . MotCleEnteteSepValeurLiteralSuite)); define("TypeMIMECharsetUTF_8",(MotCleEnteteSepSuite . "charset" . MotCleEnteteSepValeurSuite . MotCleEnteteSepValeurLiteralSuite . UTF_8 . MotCleEnteteSepValeurLiteralSuite)); define("TypeMIMEHtmlCharsetISO_8859_1",(TypeMIMEDefaut . TypeMIMECharsetISO_8859_1)); define("TypeMIMEHtmlCharsetUTF_8",(TypeMIMEDefaut . TypeMIMECharsetUTF_8)); define("TypeMIMETexteCharsetISO_8859_1",(TypeMIMETexteSep . "plain" . TypeMIMECharsetISO_8859_1)); define("TypeMIMETexteCharsetUTF_8",(TypeMIMETexteSep . "plain" . TypeMIMECharsetUTF_8)); define('TypeMIMEHtmlCharset',UNICODE_PAGE_UTF8 ? TypeMIMEHtmlCharsetUTF_8 : TypeMIMEHtmlCharsetISO_8859_1); define('TypeMIMETexteCharset',UNICODE_PAGE_UTF8 ? TypeMIMETexteCharsetUTF_8 : TypeMIMETexteCharsetISO_8859_1); define("TypeMIMEImageSep",("image" . TypeMIMESeparateur)); define("TypeMIMEImageSepPrefixe",(TypeMIMEImageSep . "x-")); define("TypeMIMEVideoSep",("video" . TypeMIMESeparateur)); define("MotCleEnteteContenuEncodage",MotCleEnteteContenu . "Transfer-Encoding"); define("LimiteMotEncode","="); define("SepMotEncode","?"); define("EmailNormal",0); define("EmailPersonnel",1); define("EmailPrive",2); define("EmailConfidentiel",3); define("EmailPrioritéBasse",0); define("EmailPrioritéNormal",100); define("EmailPrioritéHaute",200); define("LimiteDelimiteur","--"); define( "CRLF", "\r\n" ); define( "HTTPEntete", 1); define( "HTTPResultat", 2); define( "SOCKET_TAILLE_DEBUT" , 1); define( "SOCKET_MARQUEUR_FIN_BUFFER" , 2); define( "SOCKET_MARQUEUR_FIN" , 0); define( "SOCKET_SANS_MARQUEUR_FIN" , 3); define ( "MARQUEUR_FIN_DEFAUT", "<EOF>"); define( "SOCKET_ADRESSE" ,1); define( "SOCKET_PORT" ,2); define('emailValideSyntaxe' ,0); define('emailValideSyntaxeStrict' ,1); define('emailValideParServeur' ,2); define('EVA_EMAILADRESSEVALIDE' ,0);define('EVA_EMAILADRESSESYNTAXEINCORRECTE' ,1);define('EVA_EMAILADRESSEREFUSEE' ,2);define('EVA_EMAILADRESSEERREUR' ,3);$TabExtType = array("TXT" => TypeMIMETexteCharsetISO_8859_1, "HTM" => TypeMIMEHtmlCharsetISO_8859_1, "RTF" => TypeMIMETexteSep . "richtext", "WAV" => "audio" . TypeMIMESeparateur . "wav", "GIF" => TypeMIMEImageSep . "gif", "JPG" => TypeMIMEImageSep . "jpeg", "TIF" => TypeMIMEImageSep . "tiff", "PNG" => TypeMIMEImageSepPrefixe . "png", "BMP" => TypeMIMEImageSep . "bmp", "EMF" => TypeMIMEImageSepPrefixe . "emf", "WMF" => TypeMIMEImageSepPrefixe . "wmf", "AVI" => TypeMIMEVideoSep . "avi", "MPG" => TypeMIMEVideoSep . "mpeg"); $TabVariableGlobaleCOM = array(); define("SOCKET",0); define('HTTPFORMULAIRE',1); $Email = null;$ClientHTTP = null; $nTimeOutHTTP = 200; function COM_SauveVariableGlobaleInterne(&$pclPage) { global $TabVariableGlobaleCOM; $pclPage->TabVarGlobaleInterneComposante['COM'] = $TabVariableGlobaleCOM; } function COM_RestaureVariableGlobaleInterne(&$pclPage) { global $TabVariableGlobaleCOM; if (!isset($pclPage->TabVarGlobaleInterneComposante['COM'])) return; $TabVariableGlobaleCOM = $pclPage->TabVarGlobaleInterneComposante['COM']; } function F08165b4d($Liste,$NbAdresse) { return utf8_implode(",",array_slice($Liste,0,$NbAdresse)); } function F1233c432($Champ, $Valeur, $Remplacement = "", $SuiteChamp = "") { return (($Valeur . $Remplacement) != "") ? ($Champ . MotCleEnteteSeparateur . $SuiteChamp . (($Valeur != "") ? utf8_encode_mimeheader($Valeur) : utf8_encode_mimeheader($Remplacement)) . RC) : ""; } function& F2be474f9() { global $Email; if (!isset($Email)) { FMK_Charge('TYPE/Email.php',false); $Email = new CEmail(); } return $Email; } function EmailRAZ() { $pclEmail =& F2be474f9(); $pclEmail->F39f2478a(); } function EmailEnvoieMessage() { $Email =& F2be474f9(); global $TabExtType; $bTexteEThtml = (!empty($Email->HTML) && !empty($Email->Message)); $Delimiteur = ($bTexteEThtml || ($Email->NbAttache > 0)) ? (utf8_md5(uniqid(rand()))) : ''; $DelimiteurEncadre = RC . LimiteDelimiteur . $Delimiteur . RC; $Message = ($bTexteEThtml || ($Email->NbAttache > 0)) ? (RC . $DelimiteurEncadre) : ""; if ($bTexteEThtml || ($Email->NbAttache > 0)) $Message .= F1233c432(MotCleEnteteContenuType,(($Email->HTML != "")&&!$bTexteEThtml) ? TypeMIMEHtmlCharset : TypeMIMETexteCharset) . F1233c432(MotCleEnteteContenuEncodage,"8bit") . RC; if ($bTexteEThtml) { $Message .= $Email->Message; $Message .= RC . $DelimiteurEncadre;; $Message .= 'Content-Type: text/html; '; if (UNICODE_PAGE_UTF8) { $Message .= 'charset="utf-8" '.RC; } else { $Message .= 'charset="iso-8859-1" '.RC; } $Message .= $Email->HTML; } else { $Message .= ($Email->HTML != "") ? $Email->HTML : $Email->Message; } $ImageLienHTML = false; $tabKeys = array_keys( $Email->Attache ); $nOccurrence = min($Email->NbAttache , count( $tabKeys )); for($nKey = 0; $nKey < $nOccurrence; $nKey++) { $i =& $tabKeys[ $nKey ]; $Info = pathinfo(F9486bf1a($Email->Attache[$i])); $Ext = utf8_strtoupper($Info["extension"]); if (file_exists(F9486bf1a($Email->Attache[$i])) && ($fic = fopen(F9486bf1a($Email->Attache[$i]),'r')) != false) { $FichierCode = fread($fic,filesize($Email->Attache[$i])); fclose($fic); $FichierCode = chunk_split(base64_encode($FichierCode)); $ImageHTML = ($Email->HTML != "") && array_key_exists($i,$Email->IdentifiantAttache); $ImageLienHTML = $ImageLienHTML || $ImageHTML; $Message .= $DelimiteurEncadre . F1233c432(MotCleEnteteContenuType,array_key_exists($i,$Email->AttacheContentType) ? ($Email->AttacheContentType[$i]) : (array_key_exists($Ext,$TabExtType) ? ($TabExtType[$Ext]) : ("application" . TypeMIMESeparateur . "octet-stream")) . MotCleEnteteSepSuite . "name" . MotCleEnteteSepValeurSuite . MotCleEnteteSepValeurLiteralSuite . $Email->Attache[$i] . MotCleEnteteSepValeurLiteralSuite) . F1233c432(MotCleEnteteContenuEncodage,"base64") . F1233c432(MotCleEnteteContenuDisposition,SuiteEnteteAttachement . MotCleEnteteSepValeurLiteralSuite . $Email->Attache[$i] . MotCleEnteteSepValeurLiteralSuite) . ($ImageHTML ? F1233c432(MotCleEnteteContenu . "ID","<" . $Email->IdentifiantAttache[$i] . ">") : "") . (array_key_exists($i,$Email->AttacheContentDescription) ? F1233c432(MotCleEnteteContenu . "Description",$Email->AttacheContentDescription[$i]) : "") . RC . $FichierCode; } } if ($bTexteEThtml || ($Email->NbAttache > 0)) $Message .= LimiteDelimiteur . $Delimiteur . LimiteDelimiteur; switch ($Email->Confidentialite) { case EmailPersonnel : $Confidentialité = "Personal"; break; case EmailPrive : $Confidentialité = "Private"; break; case EmailConfidentiel : $Confidentialité = "Company-Confidential"; break; default : $Confidentialité = ""; break; } switch ($Email->Priorite) { case EmailPrioritéBasse : $Priorité = "Low"; break; case EmailPrioritéHaute : $Priorité = "High"; break; default : $Priorité = ""; break; } F67cfd262(); F6b1e3687(); $bReussite = utf8_mail(F08165b4d($Email->Destinataire,$Email->NbDestinataire),utf8_encode_mimeheader( $Email->Sujet ),$Message,F1233c432("From",$Email->Expediteur) . F1233c432("Reply-to",$Email->AdresseExpediteur) . F1233c432("Cc",F08165b4d($Email->Cc,$Email->NbCc)) . F1233c432("Bcc",F08165b4d($Email->Cci,$Email->NbCci)) . ($Email->AccuseReception ? F1233c432("Return-Receipt-To",$Email->AdresseExpediteur,$Email->Expediteur) : "") . ($Email->ConfirmationLecture ? F1233c432("Disposition-Notification-To",$Email->AdresseExpediteur,$Email->Expediteur) : "") . F1233c432("Sensitivity",$Confidentialité) . F1233c432("Importance",$Priorité) . F1233c432("Keywords",($Email->Categorie != "") ? (LimiteMotEncode . SepMotEncode . (UNICODE_PAGE_UTF8 ? UTF_8 : ISO_8859_1) . SepMotEncode . "B" . SepMotEncode . base64_encode($Email->Categorie) . SepMotEncode . LimiteMotEncode) : "") . ((($Email->HTML != "") || ($Email->NbAttache > 0)) ? (F1233c432("MIME-Version","1.0") . F1233c432(MotCleEnteteContenuType,($bTexteEThtml || ($Email->NbAttache > 0)) ? ("multipart" . TypeMIMESeparateur . (($ImageLienHTML||$bTexteEThtml) ? "related" : "mixed") . MotCleEnteteSepSuite . "boundary" . MotCleEnteteSepValeurSuite . MotCleEnteteSepValeurLiteralSuite . $Delimiteur . MotCleEnteteSepValeurLiteralSuite . RC) : TypeMIMEHtmlCharset)) : "")); F1e7b0563(); if (!$bReussite) { Fdd46bacf(Fc34ec142('ERR_EMAIL_ENVOIIMPOSSIBLE'),errMessage); $sMessageErrSys = F1abae4f0(); if (!empty($sMessageErrSys)) { Fdd279d21($sMessageErrSys,errMessageSysteme); } } return $bReussite; } function NetAdresseIP($Poste=null,$Indice=null) { return F924d8bc0($Poste,$Indice); } function NetNomMachine($IP = '') { if ($IP == '') return php_uname('n'); $Nom = gethostbyaddr($IP); return ($Nom == $IP) ? '' : $Nom; } function FTPConnecte($Serveur, $Utilisateur = "anonymous", $MotDePasse = "", $NumeroPort = 21, $TypeConnexion = true, $DelaiConnexion = null) { if (!isset($DelaiConnexion)) { $DelaiConnexion = 20; } else { $DelaiConnexion = F7851bebd($DelaiConnexion,0.001); } return F745539b6($Serveur, $Utilisateur, $MotDePasse, $NumeroPort, $TypeConnexion, $DelaiConnexion); } function FTPDeconnecte($Session) { return Fbe3fcdf8($Session); } function FTPCommande($Session, $Commande) { return F1b53b37b($Session, $Commande); } function FTPAttribut($Connexion = null,$NomFichier = "",$Prive = false) { return F89ba6a91($Connexion ,$NomFichier ,$Prive); } function FTPDate($Connexion = null,$NomFichier = "") { return F0b272156($Connexion ,$NomFichier); } function FTPHeure($Connexion = null,$NomFichier = "") { return F6f640a27($Connexion,$NomFichier); } function FTPDateHeure($Connexion = null,$NomFichier = "") { return Ffa5b2d77($Connexion ,$NomFichier); } function FTPRepCree($Connexion,$Repertoire) { return F29ff73cb($Connexion,$Repertoire); } function FTPEnvoie($Connexion, $NomFicRepSrc, $NomFicRepDst, $ModeTransfert = FTPModeBinaire) { return F65ece976($Connexion, $NomFicRepSrc, $NomFicRepDst, $ModeTransfert ); } function FTPListeFichier($Connexion,$NomFicRep, $NomProc, $Indicateur = FTPFichierRépertoire, $Param = 0, $Récursif = false, $Prive = false) { $clVM =& obtenirVM(); $sNomprocIndirection = $clVM->Ff06e3e53($NomProc); if (!isset($sNomprocIndirection)) { Fe81a7f9e('ERR_FCT_NON_TROUVEE',$NomProc); } return Fbf1590d7($Connexion,$NomFicRep,$sNomprocIndirection,$Indicateur,$Param,$Récursif,$Prive); } function FTPNom() { return F5166dcf5(); } function FTPRecupere($Connexion, $FicRepRecup, $FicRepDest, $ModeTransfert = FTPModeBinaire) { return Feb999699($Connexion, $FicRepRecup, $FicRepDest, $ModeTransfert); } function FTPRenommeFichier($Connexion, $sAncienNom, $sNouveauNom) { return F2ebfcb78($Connexion, $sAncienNom, $sNouveauNom); } function FTPSupprimerFichier($Connexion, $sNom) { return F9f473974($Connexion, $sNom); } function FTPRepEnCours($Connexion, $Repertoire = null) { return F7c20408d($Connexion, $Repertoire); } function FTPRepSupprime($Connexion, $Repertoire) { return F8a160d7f($Connexion, $Repertoire); } function FTPTaille($Connexion = null,$NomFichier = "") { return F38356f58($Connexion,$NomFichier); } function FTPFichierExiste($Connexion = null,$NomFichier = "") { return F38356f58($Connexion,$NomFichier)>-1; } function SocketCree($sNomSocket, $nNumPort, $sAdresse="127.0.0.1") { F67cfd262(); $cdependancesPHP = FMK_Dependance(); if (isset($cdependancesPHP)) { if (!$cdependancesPHP->F0b5f8f06('sockets')) { Erreur('ErreurGenerique',(FMK_ChaineConstruit(Fc34ec142("ERR_SOCKET_CREATION"),$sNomSocket,"Extension sockets : 0"))); } } F67cfd262(); $bResultat = false; if(!isset($sNomSocket) ||empty($sNomSocket)) { Erreur('ErreurWL',"ErreurNomSocketVide", Fc34ec142("FCT_SOCKET_CREE")); } if($nNumPort < 1 || $nNumPort > 65535) { Erreur('ErreurWL_1_Param',"ErreurSocketNumPortInvalide", $nNumPort, Fc34ec142("FCT_SOCKET_CREE")); } DebutErreurAttendue(); $resSocket = socket_create(AF_INET, SOCK_STREAM, SOL_TCP); FinErreurAttendue(); if($resSocket !== false) { DebutErreurAttendue(); $bResultat = socket_bind($resSocket,$sAdresse,$nNumPort); FinErreurAttendue(); } if(!$bResultat) { DebutErreurAttendue(); $nCodeErreur = socket_last_error(); FinErreurAttendue(); Fdd46bacf(FMK_ChaineConstruit(Fc34ec142("ERR_SOCKET_CREATION"),$sNomSocket, socket_strerror($nCodeErreur))); DebutErreurAttendue(); socket_close($resSocket); FinErreurAttendue(); } else { global $TabVariableGlobaleCOM; if(!isset($TabVariableGlobaleCOM[SOCKET])) { $TabSocket = array(); $TabVariableGlobaleCOM[SOCKET] = &$TabSocket; } else { $TabSocket = &$TabVariableGlobaleCOM[SOCKET]; } if(isset($TabSocket[$sNomSocket])) { DebutErreurAttendue(); socket_close($resSocket); FinErreurAttendue(); Erreur('ErreurWL_2_Param',"ErreurSocketExistante", Fc34ec142("FCT_SOCKET_CREE"), $sNomSocket, FCT_SOCKET_CREE); return false; } $socket = new FMK_Socket($sNomSocket, $resSocket); $TabSocket[$sNomSocket] = &$socket; } return $bResultat; } function SocketCreeUDP($sNomSocket, $nNumPort, $sAdresse="127.0.0.1") { F67cfd262(); $cdependancesPHP = FMK_Dependance(); if ( (isset($cdependancesPHP))&&(!$cdependancesPHP->F0b5f8f06('sockets')) ) { Erreur('ErreurGenerique',(FMK_ChaineConstruit(Fc34ec142("ERR_SOCKET_CREATION"),$sNomSocket,"Extension sockets : 0"))); } F67cfd262(); $bResultat = false; if(!isset($sNomSocket) ||empty($sNomSocket)) { Erreur('ErreurWL','ErreurNomSocketVide', Fc34ec142("FCT_SOCKET_CREE_UDP")); } if($nNumPort < 1 || $nNumPort > 65535) { Erreur('ErreurWL_1_Param',"ErreurSocketNumPortInvalide", $nNumPort, Fc34ec142("FCT_SOCKET_CREE_UDP")); } DebutErreurAttendue(); $resSocket = socket_create(AF_INET, SOCK_DGRAM, SOL_UDP); FinErreurAttendue(); if($resSocket !== false) { DebutErreurAttendue(); $bResultat = socket_bind($resSocket,$sAdresse,$nNumPort); FinErreurAttendue(); } if(!$bResultat) { DebutErreurAttendue(); $nCodeErreur = socket_last_error(); FinErreurAttendue(); Fdd46bacf( FMK_ChaineConstruit(Fc34ec142("ERR_SOCKET_CREATION"),$sNomSocket, socket_strerror($nCodeErreur))); DebutErreurAttendue(); socket_close($resSocket); FinErreurAttendue(); } else { global $TabVariableGlobaleCOM; if(!isset($TabVariableGlobaleCOM[SOCKET])) { $TabSocket = array(); $TabVariableGlobaleCOM[SOCKET] = &$TabSocket; } else { $TabSocket = &$TabVariableGlobaleCOM[SOCKET]; } if(isset($TabSocket[$sNomSocket])) { DebutErreurAttendue(); socket_close($resSocket); FinErreurAttendue(); Erreur('ErreurWL_2_Param',"ErreurSocketExistante", Fc34ec142("FCT_SOCKET_CREE"), $sNomSocket, FCT_SOCKET_CREE); return false; } $socket = new FMK_Socket($sNomSocket, $resSocket); $TabSocket[$sNomSocket] = &$socket; } return $bResultat; } function SocketAttendConnexion($sNomSocket, $nDuree = null) { global $sNomDerniereFonctionSocket; $sNomDerniereFonctionSocket = Fc34ec142("FCT_SOCKET_ATTEND_CONNEXION"); F67cfd262(); $socket = &F7072c895($sNomSocket); DebutErreurAttendue(); $bResultat = socket_listen($socket->resSocket); FinErreurAttendue(); if(!$bResultat) { DebutErreurAttendue(); $nCodeErreur = socket_last_error($socket->resSocket); FinErreurAttendue(); Fdd46bacf(FMK_ChaineConstruit(Fc34ec142("ERR_SOCKET_UTILISATION"),$sNomSocket, socket_strerror($nCodeErreur))); return false; } if(!isset($nDuree)) { $nDuree = -1; } else { $nDuree = F7851bebd($nDuree); } if($nDuree > 0) { $read = array($socket->resSocket); DebutErreurAttendue(); $t1=null;$t2=null; $bResult = socket_select($read,$t1,$t2,(int)($nDuree/1000),($nDuree % 1000)); FinErreurAttendue(); if($bResult) { return true; } } else { $read = array($socket->resSocket); $t1=null; $t2=null; DebutErreurAttendue(); $bResult = socket_select($read,$t1,$t2,NULL,null); FinErreurAttendue(); if($bResult) { return true; } } return false; } function SocketAccepte($sNomSocket) { global $sNomDerniereFonctionSocket; $sNomDerniereFonctionSocket = Fc34ec142("FCT_SOCKET_ACCEPTE"); F67cfd262(); $socket = &F7072c895($sNomSocket); socket_set_nonblock($socket->resSocket); DebutErreurAttendue(); $result = socket_accept($socket->resSocket); FinErreurAttendue(); if($result === false) { Fdd46bacf(Fc34ec142("ERR_SOCKET_AUCUNE_CONNEXION")); return ""; } socket_set_block($socket->resSocket); $id = Fbc375268(15); $socketCliente = new FMK_Socket($id, $result); $socketCliente->nModeTransmission = $socket->nModeTransmission; $socketCliente->sMarqueurFin = $socket->sMarqueurFin; global $TabVariableGlobaleCOM; $TabSocket = &$TabVariableGlobaleCOM[SOCKET]; $TabSocket[$id] = &$socketCliente; return $id; } function SocketChangeModeTransmission($sNomSocket, $nTypeTransmission, $sMarqueurFin = MARQUEUR_FIN_DEFAUT) { global $sNomDerniereFonctionSocket; $sNomDerniereFonctionSocket = Fc34ec142("FCT_SOCKET_CHANGE_MODE_TRANSMISSION"); F67cfd262(); $socket = &F7072c895($sNomSocket); if($nTypeTransmission < SOCKET_MARQUEUR_FIN || $nTypeTransmission > SOCKET_SANS_MARQUEUR_FIN) { Erreur('ErreurWL','ErreurSocketModeTransmissionInvalide', $sNomDerniereFonctionSocket); } $socket->nModeTransmission = $nTypeTransmission; $socket->sMarqueurFin = $sMarqueurFin; return true; } function SocketClientInfo($sNomSocket, $nTypeInfo) { global $sNomDerniereFonctionSocket; $sNomDerniereFonctionSocket = Fc34ec142("FCT_SOCKET_CLIENT_INFO"); F67cfd262(); $socket = &F7072c895($sNomSocket); $sAdresse = ""; $nPort = 0; socket_getpeername($socket->resSocket, $sAdresse, $nPort); if($nTypeInfo == SOCKET_ADRESSE) { return $sAdresse; } return $nPort; } function SocketConnecte($sNomSocket, $nNumPort, $sAdresse="127.0.0.1", $nTimeOut = 5000) { F67cfd262(); $cdependancesPHP = FMK_Dependance(); if ((isset($cdependancesPHP)) && (!$cdependancesPHP->F0b5f8f06('sockets'))) { Erreur('ErreurGenerique',(FMK_ChaineConstruit(Fc34ec142("ERR_SOCKET_CREATION"),$sNomSocket,"Extension sockets : 0"))); } F67cfd262(); $bResultat = false; if(!isset($sNomSocket) ||empty($sNomSocket)) { Erreur('ErreurWL',"ErreurNomSocketVide", Fc34ec142("FCT_SOCKET_CONNECTE")); } if($nNumPort < 1 || $nNumPort > 65535) { Erreur('ErreurWL_1_Param',"ErreurSocketNumPortInvalide", $nNumPort, Fc34ec142("FCT_SOCKET_CONNECTE")); } DebutErreurAttendue(); $resSocket = socket_create(AF_INET, SOCK_STREAM, SOL_TCP); FinErreurAttendue(); if($resSocket !== false) { DebutErreurAttendue(); $bResultat = socket_connect($resSocket, $sAdresse, $nNumPort); FinErreurAttendue(); } if(!$bResultat) { DebutErreurAttendue(); $nCodeErreur = socket_last_error(); FinErreurAttendue(); Fdd46bacf(FMK_ChaineConstruit(Fc34ec142("ERR_SOCKET_CREATION"),$sNomSocket, socket_strerror($nCodeErreur))); DebutErreurAttendue(); socket_close($resSocket); FinErreurAttendue(); } else { global $TabVariableGlobaleCOM; if(!isset($TabVariableGlobaleCOM[SOCKET])) { $TabSocket = array(); $TabVariableGlobaleCOM[SOCKET] = &$TabSocket; } else { $TabSocket = &$TabVariableGlobaleCOM[SOCKET]; } if(isset($TabSocket[$sNomSocket])) { DebutErreurAttendue(); socket_close($resSocket); FinErreurAttendue(); Erreur('ErreurWL_2_Param',"ErreurSocketExistante", Fc34ec142("FCT_SOCKET_CONNECTE"), $sNomSocket, FCT_SOCKET_CONNECTE); return false; } $socket = new FMK_Socket($sNomSocket, $resSocket); $TabSocket[$sNomSocket] = &$socket; } return $bResultat; } function SocketLit($sNomSocket, $bAttenteInfini = true, $nAttenteMax = null, $nNbMaxOctet = 4096) { global $sNomDerniereFonctionSocket; $sNomDerniereFonctionSocket = Fc34ec142("FCT_SOCKET_LIT"); F67cfd262(); $socket = &F7072c895($sNomSocket); $nTimeOut = null; if(!$bAttenteInfini) { if (!isset($nAttenteMax)) { $nTimeOut = 1000; } else { $nTimeOut = F7851bebd($nAttenteMax); } } return F760e4402($socket->resSocket,$socket->nModeTransmission, $nTimeOut, $socket->sMarqueurFin, $nNbMaxOctet); } function SocketEcrit($sNomSocket, $sMessage) { global $sNomDerniereFonctionSocket; $sNomDerniereFonctionSocket = Fc34ec142("FCT_SOCKET_ECRIT"); F67cfd262(); $socket = &F7072c895($sNomSocket); return F35b19eea($sNomSocket, $socket->resSocket,$socket->nModeTransmission,$sMessage, $socket->sMarqueurFin); } function SocketExiste($sNomSocket) { F67cfd262(); return F7072c895($sNomSocket, false) != null; } function SocketFerme($sNomSocket) { global $sNomDerniereFonctionSocket, $TabVariableGlobaleCOM; $sNomDerniereFonctionSocket = Fc34ec142("FCT_SOCKET_FERME"); F67cfd262(); $socket = &F7072c895($sNomSocket); DebutErreurAttendue(); socket_close($socket->resSocket); FinErreurAttendue(); if(isset($TabVariableGlobaleCOM[SOCKET])) { $TabSocket = &$TabVariableGlobaleCOM[SOCKET]; unset($TabSocket[$socket->sNomSocket]); } return true; } function F760e4402($socket, $nMode, $nTimeOut, $sMarqueurFin, $nNbOctet) { switch($nMode) { case SOCKET_TAILLE_DEBUT : $sMessage = ""; $time = Fc4c29d26(); while(!isset($nTimeOut) || $nTimeOut > Fc4c29d26() - $time) { $res = ""; DebutErreurAttendue(); $res = socket_read($socket,1024, 0); FinErreurAttendue(); if($res !== false) { $nPosition = utf8_strpos($res, RC); if($nPosition !== false) { $nTaille = (int)utf8_substr($res,0,$nPosition); $sMessage = utf8_substr($res, $nPosition + utf8_strlen(RC)); if(utf8_strlen($sMessage) < $nTaille) { if(($res = socket_read($socket,$nTaille - utf8_strlen($sMessage), 0)) !== false) { $sMessage .= $res; } } } break; } } return $sMessage; case SOCKET_MARQUEUR_FIN : case SOCKET_MARQUEUR_FIN_BUFFER : $sMessage = ""; $res = ""; $time = Fc4c29d26(); while(!isset($nTimeOut) || $nTimeOut > Fc4c29d26() - $time) { DebutErreurAttendue(); $res = socket_read($socket,2048, 0); FinErreurAttendue(); if($res !== false) { $sMessage .= $res; $nPosition = utf8_strpos($sMessage, $sMarqueurFin); if($nPosition !== false) { $sMessage = utf8_substr($sMessage, 0, $nPosition); break; } } } return $sMessage; case SOCKET_SANS_MARQUEUR_FIN : $sMessage = ""; $res = ""; $time = Fc4c29d26(); while(!isset($nTimeOut) || $nTimeOut > Fc4c29d26() - $time) { DebutErreurAttendue(); $res = socket_read($socket,4096,0); FinErreurAttendue(); if($res!==false) { $sMessage .= $res; if(utf8_strlen($sMessage) >= $nNbOctet) { return utf8_substr($sMessage, 0, $nNbOctet); } } } return $sMessage; } return ""; } function F35b19eea($sNomSocket, $socket, $nMode, $sMessage, $sMarqueurFin) { $nResult = false; switch($nMode) { case SOCKET_TAILLE_DEBUT : $sMessage = utf8_strlen($sMessage).RC.$sMessage; DebutErreurAttendue(); $nResult = socket_write($socket, $sMessage, utf8_strlen($sMessage)); FinErreurAttendue(); break; case SOCKET_MARQUEUR_FIN : case SOCKET_MARQUEUR_FIN_BUFFER : $sMessage = $sMessage.$sMarqueurFin; DebutErreurAttendue(); $nResult = socket_write($socket, $sMessage, utf8_strlen($sMessage)); FinErreurAttendue(); break; case SOCKET_SANS_MARQUEUR_FIN : DebutErreurAttendue(); $nResult = socket_write($socket, $sMessage, utf8_strlen($sMessage)); FinErreurAttendue(); break; } if($nResult === false) { DebutErreurAttendue(); $nCodeErreur = socket_last_error($socket); FinErreurAttendue(); Fdd46bacf(FMK_ChaineConstruit(Fc34ec142("ERR_SOCKET_UTILISATION"),$sNomSocket, socket_strerror($nCodeErreur))); return false; } return true; } function Fc4c29d26() { return Fd443b7ac(); } function F030cf07a($num, $alphanums) { $rand_value = $alphanums[$num]; return $rand_value; } function Fbc375268($length) { $alphanum = array("", "a", "b", "c", "d", "e", "f", "g", "h", "i", "j", "k", "l", "m", "n", "o", "p", "q", "r", "s", "t", "u", "v", "w", "x", "y", "z", "A", "B", "C", "D", "E", "F", "G", "H", "I", "J", "K", "L", "M", "N", "O", "P", "Q", "R", "S", "T", "U", "V", "W", "X", "Y", "Z", "0", "1", "2", "3", "4", "5", "6", "7", "8", "9"); if($length>0) { $rand_id=""; for($i=1; $i<=$length; $i++) { mt_srand((double)microtime() * 1000000); $num = mt_rand(1,62); $rand_id .= F030cf07a($num, $alphanum); } } return $rand_id; } function& F7072c895($sNomSocket, $bErreurSiInexistant = true) { $RetourParDefaut = null; global $TabVariableGlobaleCOM, $sNomDerniereFonctionSocket; if(isset($TabVariableGlobaleCOM[SOCKET])) { $TabSocket = &$TabVariableGlobaleCOM[SOCKET]; if(isset($TabSocket[$sNomSocket])) { return $TabSocket[$sNomSocket]; } } if($bErreurSiInexistant) { Erreur('ErreurWL_1_Param',"ErreurSocketInexistante", $sNomSocket, $sNomDerniereFonctionSocket); } return $RetourParDefaut; } class FMK_Socket { var $sNomSocket = ""; var $resSocket = null; var $nModeTransmission = SOCKET_TAILLE_DEBUT; var $sMarqueurFin = MARQUEUR_FIN_DEFAUT; function FMK_Socket($sNom, $res) { $this->sNomSocket = $sNom; $this->resSocket = $res; } } function HTTPRequete($sURL, $sAgent= '', $sEntete='', $sMessage='', $sTypeMessage='', $sNomUser='',$sMotDePasse='',$nMethode=null) { if (null === $nMethode) { $nMethode = (isset($sMessage) && (''!==$sMessage)) ? 2 : 1; } else { if ($nMethode<1 || $nMethode>4) { Fb9eb0792('ERR_HTTPFORM_BADMETHOD'); return false; } } F67cfd262(); global $ClientHTTP; $ClientHTTP = new FMK_ClientHTTP($sURL); $ClientHTTP->F5c2aa578(); $clContexte =& F4a1887ce(); $sAdresseProxy = $clContexte->F239ddeda('COM_Proxy_Adresse'); if (isset($sAdresseProxy)) { $ClientHTTP->F945d7dd2( $sAdresseProxy, $clContexte->F239ddeda('COM_Proxy_Port'), $clContexte->F239ddeda('COM_Proxy_Login'), $clContexte->F239ddeda('COM_Proxy_MotDePasse') ); } if(!$ClientHTTP->Ff6bf4850()) { Fdd46bacf('(Code: '.$ClientHTTP->nCodeReponseServeur.')' . RC .$ClientHTTP->sReponseServeur); return false; } if(isset($sAgent) && !empty($sAgent)) { $ClientHTTP->F49d485d7($sAgent); } if((isset($sNomUser) && !empty($sNomUser)) || (isset($sMotDePasse) && !empty($sMotDePasse))) { $ClientHTTP->F2e512fe5($sNomUser, $sMotDePasse); } if(!isset($sTypeMessage) || empty($sTypeMessage)) { $sTypeMessage = 'application/x-www-form-urlencoded'; } $ClientHTTP->Fc690282a($sTypeMessage); if (!empty($sEntete)) { $ClientHTTP->enteteRequeteUtilisateur = $sEntete; } $clHeader = ''; $clHeader.=( $ClientHTTP->URLServeur['host'] ); if (utf8_strpos($ClientHTTP->URLServeur['host'],':')===false) $clHeader.=utf8_sprintf(":%d",$ClientHTTP->nPortServeur); $ClientHTTP->enteteRequete["Host"] = $clHeader; $bResultat = $ClientHTTP->Fdfdc7c15($sMessage,$nMethode); if(!$bResultat) { Fdd46bacf('(Code: '.$ClientHTTP->nCodeReponseServeur.')' . RC .$ClientHTTP->sReponseServeur); } $ClientHTTP->F2d4e3fa8(); return $bResultat; } function HTTPDonneResultat($nTypeInfo = HTTPResultat) { global $ClientHTTP; $sRetour = ''; if(!isset($ClientHTTP)) { return $sRetour; } if($nTypeInfo & HTTPEntete) { $sEntete = ''; $entete = $ClientHTTP->enteteRequete; if(isset($entete) && !empty($entete)) { foreach ($entete as $cle => $valeur) { if(!empty($cle)) { $sEntete .= $cle.': '.$valeur; } else { $sEntete .= $valeur; } $sEntete .= RC; } } $sRetour = $sEntete; } if($nTypeInfo & HTTPResultat) { $sRetour .= $ClientHTTP->corpsRequete; } return $sRetour; } function HTTPTimeOut($nTimeOut=null) { global $nTimeOutHTTP; if(isset($nTimeOut)) { $nTimeOutHTTP = floatval(F7851bebd($nTimeOut))/1000; } else { return $nTimeOutHTTP*1000; } return null; } function Proxy($sAdresseProxy, $nPortProxy = 8080, $sLogin = null, $sMotDePasse = '') { $clContexte =& F4a1887ce(); if ($sAdresseProxy === '') { $clContexte->Ff9d5e233('COM_Proxy_Adresse'); $clContexte->Ff9d5e233('COM_Proxy_Port'); $clContexte->Ff9d5e233('COM_Proxy_Login'); $clContexte->Ff9d5e233('COM_Proxy_MotDePasse'); } else { $clContexte->F4c8f9bd4('COM_Proxy_Adresse',$sAdresseProxy); $clContexte->F4c8f9bd4('COM_Proxy_Port',$nPortProxy); $clContexte->F4c8f9bd4('COM_Proxy_Login',$sLogin); $clContexte->F4c8f9bd4('COM_Proxy_MotDePasse',$sMotDePasse); } } class FMK_ClientHTTP { var $URLServeur; var $nPortServeur; var $nCodeReponseServeur; var $sReponseServeur; var $nProtocoleVersion = "1.0"; var $enteteRequete, $corpsRequete, $enteteRequeteUtilisateur; var $socket = false; var $bProxy = false; var $sAdresseProxy; var $nPortProxy; var $sProtocole; function FMK_ClientHTTP($sURL, $nPort=null) { $this->F1a881c31($sURL, $nPort); } function F1a881c31($sURL, $nPort=null) { $result = array(); $sURL = utf8_str_replace(' ','%20',utf8_trim($sURL)); if ( (!isset($sURL[0])) || ($sURL === '/') ) $sURL = 'http://' . F78b7df27() . $sURL; if ($sURL[0] === '/') { $sURL = 'http://127.0.0.1' . $sURL; } if ((utf8_strpos($sURL,'https')===0)) { $this->sProtocole = 'https'; if ($nPort === null) $nPort = 443; } else { $this->sProtocole = 'http'; if ($nPort === null) $nPort = 80; } $this->URLServeur['host'] = ''; $this->URLServeur['path'] = '/'; if(preg_match("/(http:\/\/|https:\/\/)?(.+?)(\/(.*)|$)/".UNICODE_REGEXP."i",$sURL,$result)) { $this->URLServeur['host'] = $result[2]; if ('localhost' === $this->URLServeur['host']) $this->URLServeur['host'] = '127.0.0.1'; if(isset($result[3])&&!empty($result[3])) { $this->URLServeur['path'] = $result[3]; } $nPosition = utf8_strpos($this->URLServeur['host'], ':'); if($nPosition!==false) { $nPort = (int)F3449a00a($this->URLServeur['host'],$nPosition+2,utf8_strlen($this->URLServeur['host'])); $this->URLServeur['host'] = F3449a00a($this->URLServeur['host'],0,$nPosition); } } $this->nPortServeur = $nPort; } function Ff6bf4850() { global $nTimeOutHTTP; $sHost = ($this->bProxy) ? $this->sAdresseProxy : $this->URLServeur['host']; $nPort = ($this->bProxy) ? $this->nPortProxy: $this->nPortServeur; if ($nPort == 443) { $sHost = 'ssl://' . $sHost; } if($nTimeOutHTTP >= 0) { DebutErreurAttendue(); $this->socket = fsockopen($sHost, $nPort, $this->nCodeReponseServeur, $this->sReponseServeur,$nTimeOutHTTP); FinErreurAttendue(); if($this->socket) { stream_set_timeout($this->socket, 0, $nTimeOutHTTP); } } else { DebutErreurAttendue(); $this->socket = fsockopen($sHost, $nPort, $this->nCodeReponseServeur, $this->sReponseServeur); FinErreurAttendue(); } return $this->socket != 0; } function F2d4e3fa8() { if($this->socket) { fclose($this->socket); } } function F5c2aa578() { $this->enteteRequete = array(); $this->corpsRequete = ""; } function F49d485d7($sUserAgent) { $this->enteteRequete["User-Agent"] = $sUserAgent; } function F2e512fe5($sNumUtilisateur, $sMotDePasse) { $sEncode = base64_encode( "$sNumUtilisateur:$sMotDePasse" ); $this->enteteRequete["Authorization"] = "Basic ".$sEncode; } function F945d7dd2($sUrlProxy, $nPortProxy = 8080, $sNomUtilisateur = null, $sMotDePasse = '') { $this->nPortProxy = $nPortProxy; $this->sAdresseProxy = $sUrlProxy; $this->bProxy = true; if (isset($sNomUtilisateur)) { $sEncode = base64_encode( "$sNomUtilisateur:$sMotDePasse" ); $this->enteteRequete["Proxy-Authorization"] = "Basic ".$sEncode; } } function Fc690282a($sTypeContenu) { $this->enteteRequete["Content-Type"] = $sTypeContenu; } function Fdfdc7c15($sMessage,$eMethode) { if (!is_object($sMessage)) { switch($eMethode) { case 2: return $this->Fd31545ef($sMessage); break; case 1: return $this->Fe160293f(); break; case 3: case 4: default: Fb9eb0792('ERR_HTTPFORM_BADMETHOD'); return false; } } $pclFormulaire =& $sMessage; $dwTailleFormulaire=0; if(($eMethode!==1)&&($eMethode!==4)) { $dwTailleFormulaire=$pclFormulaire->Fbdf37d13($this->enteteRequete["Content-Type"]); } $pszUserAgentAnsi = $this->enteteRequete["User-Agent"]; $pszMoreHeaderAnsi = $this->enteteRequeteUtilisateur; $clHeader = ''; $clHeader = utf8_sprintf("Content-Length: %d\r\n", $dwTailleFormulaire); $clHeader.=( "Content-Type: " ); $clHeader.=( $pclFormulaire->Fec4f3a50($this->enteteRequete["Content-Type"]) ); $clHeader.=( "\r\n" ); $clHeader.=( "Accept:  */*\r\n" ); $clHeader.=utf8_sprintf("User-Agent: %s\r\n", $pszUserAgentAnsi ); $clHeader.=( "Connection: close\r\n" ); $clHeader.=( $pszMoreHeaderAnsi ); if (isset($this->enteteRequete["Authorization"])) { $clHeader .= 'Authorization: '.$this->enteteRequete["Authorization"]. CRLF; } if (isset($this->enteteRequete["Proxy-Authorization"])) { $clHeader .= 'Proxy-Authorization: '.$this->enteteRequete["Proxy-Authorization"]. CRLF; } foreach( $this->enteteRequete as $cle => $valeur ) { if (utf8_strpos($clHeader,$cle.':')===false) { $clHeader .= "$cle: $valeur" . CRLF; } } $clRequest = ''; $cszURL = $this->URLServeur['path']; switch($eMethode) { case 1: $pclFormulaire->F96848610($cszURL); $clRequest = utf8_sprintf("GET %s HTTP/1.1\r\n%s\r\n", $cszURL ,$clHeader); break; case 2: $clRequest = utf8_sprintf("POST %s HTTP/1.1\r\n%s\r\n", $cszURL,$clHeader); break; case 3: $clRequest = utf8_sprintf("PUT %s HTTP/1.1\r\n%s\r\n", $cszURL,$clHeader); break; case 4: $pclFormulaire->F96848610($cszURL); $clRequest = utf8_sprintf("DELETE %s HTTP/1.1\r\n%s\r\n", $cszURL,$clHeader); break; default: Fb9eb0792('ERR_HTTPFORM_BADMETHOD'); return false; } if( ($eMethode!==1) && ($eMethode!==4) ) { $nRes = $pclFormulaire->F205d45f5($clRequest); } $this->F38cb15a8( $this->socket, $clRequest . CRLF ); $this->Fb11589a7(); return ($this->nCodeReponseServeur!=-1 && $this->nCodeReponseServeur < 400); } function F38cb15a8($fp, $string) { $nTaille = utf8_strlen($string); $fwrite=0; for ($written = 0; $written < $nTaille; $written += $fwrite) { $fwrite = fwrite($fp, utf8_substr($string, $written)); if ($fwrite === false) { return $fwrite; } } return $written; } function Fb2b38e74() { return $this->sProtocole.'://'.$this->URLServeur['host'].$this->URLServeur['path']; } function Fe160293f() { if( $this->socket == false or feof( $this->socket) ) { if(!$this->Ff6bf4850()) { return false; } } $sCommande = 'GET '.$this->Fb2b38e74().' HTTP/'.$this->nProtocoleVersion; $sCommande .= CRLF; if(isset($this->enteteRequete) && !empty($this->enteteRequete)) { if(is_array( $this->enteteRequete)) { foreach( $this->enteteRequete as $cle => $valeur ) { $sCommande .= "$cle: $valeur" . CRLF; } } } if (!empty($this->enteteRequeteUtilisateur)) { $sCommande .= $this->enteteRequeteUtilisateur . CRLF; } fputs( $this->socket, $sCommande . CRLF ); $this->Fb11589a7(); return ($this->nCodeReponseServeur!=-1 && $this->nCodeReponseServeur < 400); } function Fd31545ef($sMessage=null) { if( $this->socket == false or feof( $this->socket) ) { if(!$this->Ff6bf4850()) { return false; } } $sPrefix = ''; $sSuffix = null; $sHost = $this->URLServeur['host']; $sPath = $this->URLServeur['path']; $sPrefix = $this->sProtocole . '://'; if (utf8_strpos($this->URLServeur['host'],'?')!==false) { list($sHost,$sSuffix) = utf8_explode('?',$this->URLServeur['host']); } elseif (utf8_strpos($this->URLServeur['path'],'?')!==false) { list($sPath,$sSuffix) = utf8_explode('?',$this->URLServeur['path']); } else { $sSuffix = ''; } if (!empty($sSuffix)) { $sPath .= '?' . $sSuffix; } $sSuffix = $sMessage; $sCommande = "POST ". $sPrefix . $sHost .$sPath." HTTP/".$this->nProtocoleVersion; $sCommande .= CRLF; if(isset($sSuffix)) { $this->enteteRequete["Content-Length"] = utf8_strlen($sSuffix); } if(isset($this->enteteRequete) && !empty($this->enteteRequete)) { if(is_array( $this->enteteRequete)) { foreach( $this->enteteRequete as $cle => $valeur ) { $sCommande .= "$cle: $valeur" . CRLF; } } } if (!empty($this->enteteRequeteUtilisateur)) { $sCommande .= $this->enteteRequeteUtilisateur . CRLF; } if (!empty($sSuffix)) { $sCommande .= CRLF . $sSuffix; } fputs( $this->socket, $sCommande . CRLF ); $this->Fb11589a7(); return ($this->nCodeReponseServeur!=-1 && $this->nCodeReponseServeur < 400); } function Fa5a3c96f($sReponseServeur) { $result = null; if( preg_match( "|^HTTP/\S+ (\d+) |i", $sReponseServeur, $result )) { $this->nCodeReponseServeur = $result[1]; } else { $this->nCodeReponseServeur = -1; } } function Fb11589a7() { global $nTimeOutHTTP; $t0 = Fc4c29d26(); do { $this->sReponseServeur = utf8_trim(fgets( $this->socket,1024) ); if ($this->sReponseServeur === '') usleep(2); else break; } while (Fc4c29d26() - $t0 <= $nTimeOutHTTP*1000); $this->Fa5a3c96f($this->sReponseServeur); $this->enteteRequete = $this->F554143e1($t0); $this->corpsRequete = $this->F23522425($t0); $clContexte =& F4a1887ce(); if ( true === $clContexte->F1a1d6423('COM_HTTP_Destination') ) { XVERIFY( F7973cde3($clContexte->F239ddeda('COM_HTTP_Destination'),$this->corpsRequete) ); $this->corpsRequete = ''; } $clContexte->Ff9d5e233('COM_HTTP_Destination'); } function F554143e1($t0) { global $nTimeOutHTTP; $entete = array(); $bFini = false; while ((!$bFini ) && (!feof($this->socket)) ) { $sLecture=false; do { if (Fc4c29d26() - $t0 > $nTimeOutHTTP*1000) return $entete; $sLecture = fgets( $this->socket, 1024 ); } while ($sLecture===false); $bFini = ($sLecture == CRLF) ; if (!$bFini) { if(FMK_Position($sLecture,":") > 0) { list( $sNomElement, $sValeurElement ) = utf8_explode( ": ", $sLecture, 2 ); if(isset($entete[$sNomElement])) { $entete[$sNomElement] .= "; " . utf8_trim($sValeurElement); } else { $entete[$sNomElement] = utf8_trim($sValeurElement); } } else { $entete[""] = utf8_trim($sLecture); if ($this->nCodeReponseServeur === -1) { $this->Fa5a3c96f($sLecture); if ($this->nCodeReponseServeur >= 400) return $entete; } } } } return $entete; } function F23522425($t0) { global $nTimeOutHTTP; $data = ""; $nCompteur = 0; $status = null; do { $status = socket_get_status($this->socket); if( $status['eof'] == 1 ) { break; } if( $status['unread_bytes'] > 0 ) { $buffer = fread( $this->socket, $status['unread_bytes'] ); $nCompteur = 0; } else { $buffer = fread( $this->socket, 1024 ); usleep(2); } $data .= $buffer; } while( ( $status['unread_bytes'] > 0 || $nCompteur++ < 1000 ) && (Fc4c29d26() - $t0 <= $nTimeOutHTTP*1000) ); return $data; } } function EmailVerifieAdresse($sEmail, $nNiveauValidation = null) { if (!isset($nNiveauValidation)) { $nNiveauValidation = emailValideSyntaxe; } elseif ($nNiveauValidation & emailValideParServeur) { Fe81a7f9e('ERR_EMAILVERIFIEADRESSE_LIMITATION_SERVEUR'); return EVA_EMAILADRESSEERREUR; } $nResultat = Ff9347b6f($sEmail); if ($nNiveauValidation==emailValideSyntaxe) return $nResultat; switch($nNiveauValidation) { case emailValideSyntaxeStrict: return Ff7fb4272($sEmail); default: Fe81a7f9e('ERR_PARAMETRE_VALEUR_INCORRECT','FCT_EMAILVERIFIEADRESSE'); } return EVA_EMAILADRESSEERREUR; } function Ff9347b6f($szAdresse) { if (!defined('EMAIL822_ADRESSE')) { Fa2c48cf1(); } $clregExp = EMAIL822_ADRESSE; if (preg_match('/'.$clregExp.'/',$szAdresse)==1) { return EVA_EMAILADRESSEVALIDE; } return EVA_EMAILADRESSESYNTAXEINCORRECTE; } function Ff7fb4272($szAdresse) { if (!defined('EMAIL822_ADRESSE_STRICT')) { Fa2c48cf1(); } $clregExp = EMAIL822_ADRESSE_STRICT; if (preg_match('/'.$clregExp.'/',$szAdresse)==1) { return EVA_EMAILADRESSEVALIDE; } return EVA_EMAILADRESSESYNTAXEINCORRECTE; } function Fa2c48cf1() { define( 'EMAIL822_CARACTERE' ,("([a-z0-9!#$%&'*+\/=?^_`{|}~-])")); define( 'EMAIL822_CARACTERE_QUOTE' ,("([ @a-z0-9!#$%&'*+\/=?^_`{|}~-]|\\\\\")")); define( 'EMAIL822_LOCAL_SIMPLE' ,EMAIL822_CARACTERE . ("+(\\.") . EMAIL822_CARACTERE . ("+)*")); define( 'EMAIL822_LOCAL_QUOTE' ,("\"") . EMAIL822_CARACTERE_QUOTE . ("+(\\.") . EMAIL822_CARACTERE_QUOTE . ("+)*\"")); define( 'EMAIL822_LOCAL' ,("(") . EMAIL822_LOCAL_SIMPLE . ("|") . EMAIL822_LOCAL_QUOTE . (")")); define( 'EMAIL822_DOMAINE_BASE' ,("([a-z0-9]([a-z0-9-]*[a-z0-9])?\\.)*")); define( 'EMAIL822_DOMAINE_TLD_SOUPLE' ,EMAIL822_DOMAINE_BASE . ("[a-z0-9]([a-z0-9-]*[a-z0-9])?")); define( 'EMAIL822_DOMAINE_TLD' ,("(aaa|aarp|abarth|abb|abbott|abbvie|abc|able|abogado|abudhabi|ac|academy|accenture|accountant|accountants|aco|active|actor|ad|adac|ads|adult|ae|aeg|aero|aetna|af|afamilycompany|afl|africa|ag|agakhan|agency|ai|aig|aigo|airbus|airforce|airtel|akdn|al|") . ("alfaromeo|alibaba|alipay|allfinanz|allstate|ally|alsace|alstom|am|americanexpress|americanfamily|amex|amfam|amica|amsterdam|analytics|android|anquan|anz|ao|aol|apartments|app|apple|aq|aquarelle|ar|aramco|archi|army|arpa|art|arte|as|asda|asia|associates|at|athleta|attorney|") . ("au|auction|audi|audible|audio|auspost|author|auto|autos|avianca|aw|aws|ax|axa|az|azure|") . ("ba|baby|baidu|banamex|bananarepublic|band|bank|bar|barcelona|barclaycard|barclays|barefoot|bargains|baseball|basketball|bauhaus|bayern|bb|bbc|bbt|bbva|bcg|bcn|bd|be|beats|beauty|beer|bentley|berlin|best|bestbuy|bet|bf|bg|bh|bharti|bi|bible|bid|bike|bing|bingo|bio|biz|bj|") . ("black|blackfriday|blanco|blockbuster|blog|bloomberg|blue|bm|bms|bmw|bn|bnl|bnpparibas|bo|boats|boehringer|bofa|bom|bond|boo|book|booking|boots|bosch|bostik|boston|bot|boutique|box|br|bradesco|bridgestone|broadway|broker|brother|brussels|bs|bt|budapest|bugatti|build|builders|") . ("business|buy|buzz|bv|bw|by|bz|bzh|") . ("ca|cab|cafe|cal|call|calvinklein|cam|camera|camp|cancerresearch|canon|capetown|capital|capitalone|car|caravan|cards|care|career|careers|cars|cartier|casa|case|caseih|cash|casino|cat|catering|catholic|cba|cbn|cbre|cbs|cc|cd|ceb|center|ceo|cern|cf|cfa|cfd|cg|ch|chanel|channel|") . ("chase|chat|cheap|chintai|chloe|christmas|chrome|chrysler|church|ci|cipriani|circle|cisco|citadel|citi|citic|city|cityeats|ck|cl|claims|cleaning|click|clinic|clinique|clothing|cloud|club|clubmed|cm|cn|co|coach|codes|coffee|college|cologne|com|comcast|commbank|community|company|") . ("compare|computer|comsec|condos|construction|consulting|contact|contractors|cooking|cookingchannel|cool|coop|corsica|country|coupon|coupons|courses|cr|credit|creditcard|creditunion|cricket|crown|crs|cruise|cruises|csc|cu|cuisinella|cv|cw|cx|cy|cymru|cyou|cz|") . ("dabur|dad|dance|data|date|dating|datsun|day|dclk|dds|de|deal|dealer|deals|degree|delivery|dell|deloitte|delta|democrat|dental|dentist|desi|design|dev|dhl|diamonds|diet|digital|direct|directory|discount|discover|dish|diy|dj|dk|dm|dnp|do|docs|doctor|dodge|dog|doha|domains|dot|") . ("download|drive|dtv|dubai|duck|dunlop|duns|dupont|durban|dvag|dvr|dz|") . ("earth|eat|ec|eco|edeka|edu|education|ee|eg|email|emerck|energy|engineer|engineering|enterprises|epost|epson|equipment|er|ericsson|erni|es|esq|estate|esurance|et|eu|eurovision|eus|events|everbank|exchange|expert|exposed|express|extraspace|") . ("fage|fail|fairwinds|faith|family|fan|fans|farm|farmers|fashion|fast|fedex|feedback|ferrari|ferrero|fi|fiat|fidelity|fido|film|final|finance|financial|fire|firestone|firmdale|fish|fishing|fit|fitness|fj|fk|flickr|flights|flir|florist|flowers|") . ("fly|fm|fo|foo|food|foodnetwork|football|ford|forex|forsale|forum|foundation|fox|fr|free|fresenius|frl|frogans|frontdoor|frontier|ftr|fujitsu|fujixerox|fun|fund|furniture|futbol|fyi|") . ("ga|gal|gallery|gallo|gallup|game|games|gap|garden|gb|gbiz|gd|gdn|ge|gea|gent|genting|george|gf|gg|ggee|gh|gi|gift|gifts|gives|giving|gl|glade|glass|gle|global|globo|gm|gmail|gmbh|gmo|gmx|gn|godaddy|gold|goldpoint|golf|goo|goodhands|goodyear|") . ("goog|google|gop|got|gov|gp|gq|gr|grainger|graphics|gratis|green|gripe|group|gs|gt|gu|guardian|gucci|guge|guide|guitars|guru|gw|gy|") . ("hair|hamburg|hangout|haus|hbo|hdfc|hdfcbank|health|healthcare|help|helsinki|here|hermes|hgtv|hiphop|hisamitsu|hitachi|hiv|hk|hkt|hm|hn|hockey|holdings|holiday|homedepot|homegoods|homes|homesense|honda|honeywell|horse|hospital|host|hosting|hot|hoteles|hotels|hotmail|house|how|") . ("hr|hsbc|ht|htc|hu|hughes|hyatt|hyundai|") . ("ibm|icbc|ice|icu|id|ie|ieee|ifm|ikano|il|im|imamat|imdb|immo|immobilien|in|industries|infiniti|info|ing|ink|institute|insurance|insure|int|intel|international|intuit|investments|io|ipiranga|iq|ir|irish|is|iselect|ismaili|ist|istanbul|it|itau|itv|iveco|iwc|") . ("jaguar|java|jcb|jcp|je|jeep|jetzt|jewelry|jio|jlc|jll|jm|jmp|jnj|jo|jobs|joburg|jot|joy|jp|jpmorgan|jprs|juegos|juniper|") . ("kaufen|kddi|ke|kerryhotels|kerrylogistics|kerryproperties|kfh|kg|kh|ki|kia|kim|kinder|kindle|kitchen|kiwi|km|kn|koeln|komatsu|kosher|kp|kpmg|kpn|kr|krd|kred|kuokgroup|kw|ky|kyoto|kz|") . ("la|lacaixa|ladbrokes|lamborghini|lamer|lancaster|lancia|lancome|land|landrover|lanxess|lasalle|lat|latino|latrobe|law|lawyer|lb|lc|lds|lease|leclerc|lefrak|legal|lego|lexus|lgbt|li|liaison|lidl|life|lifeinsurance|lifestyle|lighting|like|lilly|limited|limo|lincoln|linde|link|") . ("lipsy|live|living|lixil|lk|loan|loans|locker|locus|loft|lol|london|lotte|lotto|love|lpl|lplfinancial|lr|ls|lt|ltd|ltda|lu|lundbeck|lupin|luxe|luxury|lv|ly|") . ("ma|macys|madrid|maif|maison|makeup|man|management|mango|market|marketing|markets|marriott|marshalls|maserati|mattel|mba|mc|mcd|mcdonalds|mckinsey|md|me|med|media|meet|melbourne|meme|memorial|men|menu|meo|metlife|mg|mh|miami|microsoft|mil|mini|mint|mit|mitsubishi|mk|ml|mlb|mls|") . ("mm|mma|mn|mo|mobi|mobile|mobily|moda|moe|moi|mom|monash|money|monster|montblanc|mopar|mormon|mortgage|moscow|moto|motorcycles|mov|movie|movistar|mp|mq|mr|ms|msd|mt|mtn|mtpc|mtr|mu|museum|mutual|mv|mw|mx|my|mz|") . ("na|nab|nadex|nagoya|name|nationwide|natura|navy|nba|nc|ne|nec|net|netbank|netflix|network|neustar|new|newholland|news|next|nextdirect|nexus|nf|nfl|ng|ngo|nhk|ni|nico|nike|nikon|ninja|nissan|nissay|nl|no|nokia|northwesternmutual|norton|now|nowruz|nowtv|np|nr|nra|nrw|ntt|nu|nyc|nz|") . ("obi|observer|off|office|okinawa|olayan|olayangroup|oldnavy|ollo|om|omega|one|ong|onl|online|onyourside|ooo|open|oracle|orange|org|organic|origins|osaka|otsuka|ott|ovh|") . ("pa|page|pamperedchef|panasonic|panerai|paris|pars|partners|parts|party|passagens|pay|pccw|pe|pet|pf|pfizer|pg|ph|pharmacy|philips|phone|photo|photography|photos|physio|piaget|pics|pictet|pictures|pid|pin|ping|pink|pioneer|pizza|pk|pl|place|play|playstation|plumbing|plus|pm|pn|pnc|") . ("pohl|poker|politie|porn|post|pr|pramerica|praxi|press|prime|pro|prod|productions|prof|progressive|promo|properties|property|protection|pru|prudential|ps|pt|pub|pw|pwc|py|") . ("qa|qpon|quebec|quest|qvc|") . ("racing|radio|raid|re|read|realestate|realtor|realty|recipes|red|redstone|redumbrella|rehab|reise|reisen|reit|reliance|ren|rent|rentals|repair|report|republican|rest|restaurant|review|reviews|rexroth|rich|richardli|ricoh|rightathome|ril|rio|rip|rmit|ro|rocher|rocks|rodeo|rogers|room|") . ("rs|rsvp|ru|rugby|ruhr|run|rw|rwe|ryukyu|") . ("sa|saarland|safe|safety|sakura|sale|salon|samsclub|samsung|sandvik|sandvikcoromant|sanofi|sap|sapo|sarl|sas|save|saxo|sb|sbi|sbs|sc|sca|scb|schaeffler|schmidt|scholarships|school|schule|schwarz|science|scjohnson|scor|scot|sd|se|seat|secure|security|seek|select|sener|services|ses|seven|") . ("sew|sex|sexy|sfr|sg|sh|shangrila|sharp|shaw|shell|shia|shiksha|shoes|shop|shopping|shouji|show|showtime|shriram|si|silk|sina|singles|site|sj|sk|ski|skin|sky|skype|sl|sling|sm|smart|smile|sn|sncf|so|soccer|social|softbank|software|sohu|solar|solutions|song|sony|soy|space|spiegel|spot|") . ("spreadbetting|sr|srl|srt|st|stada|staples|star|starhub|statebank|statefarm|statoil|stc|stcgroup|stockholm|storage|store|stream|studio|study|style|su|sucks|supplies|supply|support|surf|surgery|suzuki|sv|swatch|swiftcover|swiss|sx|sy|sydney|symantec|systems|sz|") . ("tab|taipei|talk|taobao|target|tatamotors|tatar|tattoo|tax|taxi|tc|tci|td|tdk|team|tech|technology|tel|telecity|telefonica|temasek|tennis|teva|tf|tg|th|thd|theater|theatre|tiaa|tickets|tienda|tiffany|tips|tires|tirol|tj|tjmaxx|tjx|tk|tkmaxx|tl|tm|tmall|tn|to|today|tokyo|tools|top|toray|") . ("toshiba|total|tours|town|toyota|toys|tr|trade|trading|training|travel|travelchannel|travelers|travelersinsurance|trust|trv|tt|tube|tui|tunes|tushu|tv|tvs|tw|tz|") . ("ua|ubank|ubs|uconnect|ug|uk|unicom|university|uno|uol|ups|us|uy|uz|") . ("va|vacations|vana|vanguard|vc|ve|vegas|ventures|verisign|versicherung|vet|vg|vi|viajes|video|vig|viking|villas|vin|vip|virgin|visa|vision|vista|vistaprint|viva|vivo|vlaanderen|vn|vodka|volkswagen|volvo|vote|voting|voto|voyage|vu|vuelos|") . ("wales|walmart|walter|wang|wanggou|warman|watch|watches|weather|weatherchannel|webcam|weber|website|wed|wedding|weibo|weir|wf|whoswho|wien|wiki|williamhill|win|windows|wine|winners|wme|wolterskluwer|woodside|work|works|world|wow|ws|wtc|wtf|") . ("xbox|xerox|xfinity|xihuan|xin|xn--11b4c3d|xn--1ck2e1b|xn--1qqw23a|xn--30rr7y|xn--3bst00m|xn--3ds443g|xn--3e0b707e|xn--3oq18vl8pn36a|xn--3pxu8k|xn--42c2d9a|xn--45brj9c|xn--45q11c|xn--4gbrim|xn--54b7fta0cc|xn--55qw42g|xn--55qx5d|xn--5su34j936bgsg|xn--5tzm5g|xn--6frz82g|xn--6qq986b3xl|") . ("xn--80adxhks|xn--80ao21a|xn--80aqecdr1a|xn--80asehdb|xn--80aswg|xn--8y0a063a|xn--90a3ac|xn--90ae|xn--90ais|xn--9dbq2a|xn--9et52u|xn--9krt00a|xn--b4w605ferd|xn--bck1b9a5dre4c|xn--c1avg|xn--c2br7g|xn--cck2b3b|xn--cg4bki|xn--clchc0ea0b2g2a9gcd|xn--czr694b|xn--czrs0t|xn--czru2d|xn--d1acj3b|") . ("xn--d1alf|xn--e1a4c|xn--eckvdtc9d|xn--efvy88h|xn--estv75g|xn--fct429k|xn--fhbei|xn--fiq228c5hs|xn--fiq64b|xn--fiqs8s|xn--fiqz9s|xn--fjq720a|xn--flw351e|xn--fpcrj9c3d|xn--fzc2c9e2c|xn--fzys8d69uvgm|xn--g2xx48c|xn--gckr3f0f|xn--gecrj9c|xn--gk3at1e|xn--h2brj9c|xn--hxt814e|xn--i1b6b1a6a2e|") . ("xn--imr513n|xn--io0a7i|xn--j1aef|xn--j1amh|xn--j6w193g|xn--jlq61u9w7b|xn--jvr189m|xn--kcrx77d1x4a|xn--kprw13d|xn--kpry57d|xn--kpu716f|xn--kput3i|xn--l1acc|xn--lgbbat1ad8j|xn--mgb9awbf|xn--mgba3a3ejt|xn--mgba3a4f16a|xn--mgba7c0bbn0a|xn--mgbaam7a8h|xn--mgbab2bd|xn--mgbai9azgqp6j|") . ("xn--mgbayh7gpa|xn--mgbb9fbpob|xn--mgbbh1a71e|xn--mgbc0a9azcg|xn--mgbca7dzdo|xn--mgberp4a5d4ar|xn--mgbi4ecexp|xn--mgbpl2fh|xn--mgbt3dhd|xn--mgbtx2b|xn--mgbx4cd0ab|xn--mix891f|xn--mk1bu44c|xn--mxtq1m|xn--ngbc5azd|xn--ngbe9e0a|xn--node|xn--nqv7f|xn--nqv7fs00ema|xn--nyqy26a|xn--o3cw4h|") . ("xn--ogbpf8fl|xn--p1acf|xn--p1ai|xn--pbt977c|xn--pgbs0dh|xn--pssy2u|xn--q9jyb4c|xn--qcka1pmc|xn--qxam|xn--rhqv96g|xn--rovu88b|xn--s9brj9c|xn--ses554g|xn--t60b56a|xn--tckwe|xn--tiq49xqyj|xn--unup4y|xn--vermgensberater-ctb|xn--vermgensberatung-pwb|xn--vhquv|xn--vuq861b|") . ("xn--w4r85el8fhu5dnra|xn--w4rs40l|xn--wgbh1c|xn--wgbl6a|xn--xhq521b|xn--xkc2al3hye2a|xn--xkc2dl3a5ee0h|xn--y9a3aq|xn--yfro4i67o|xn--ygbi2ammx|xn--zfr164b|xperia|xxx|xyz|") . ("yachts|yahoo|yamaxun|yandex|ye|yodobashi|yoga|yokohama|you|youtube|yt|yun|") . ("za|zappos|zara|zero|zip|zippo|zm|zone|zuerich|zw)")); define( 'EMAIL822_DOMAINE_TLD_STRICT' ,EMAIL822_DOMAINE_BASE . EMAIL822_DOMAINE_TLD ); define( 'EMAIL822_ADRESSE' ,"^" . EMAIL822_LOCAL . ("@("). EMAIL822_DOMAINE_TLD_SOUPLE . (")"). "$" ); define( 'EMAIL822_ADRESSE_STRICT' ,"^" . EMAIL822_LOCAL . ("@") . EMAIL822_DOMAINE_TLD_STRICT . "$"); } function HashChaine($nAlgo,$sChaine,$sClef=null) { $Resultat = F4f3897a1($nAlgo,$sChaine,$sClef); if ($Resultat===false) { Fe81a7f9e('ERR_BAD_CONSTANT',$nAlgo,'FCT_HASHCHAINE'); } return $Resultat; } function HashVerifieChaine($nAlgo,$sChaine,$sHash,$sClef=null) { $Resultat = F4f3897a1($nAlgo,$sChaine,$sClef); if ($Resultat===false) { Fe81a7f9e('ERR_BAD_CONSTANT',$nAlgo,'FCT_HASHVERIFIECHAINE'); } return ($Resultat == $sHash); } function HashFichier($nAlgo,$sCheminFichier,$sClef=null) { F67cfd262(); $sChaine = F8ca52887($sCheminFichier); if ($sChaine === RetourErreur_Entier) { Fdd46bacf(FMK_ChaineConstruit(Fc34ec142("ERR_FICHIER_INEXISTANT"),$sCheminFichier)); return ''; } $Resultat = F4f3897a1($nAlgo,$sChaine,$sClef); if ($Resultat===false) { Fe81a7f9e('ERR_HASH_BAD_CONSTANT',$nAlgo,'FCT_HASHFICHIER'); } return $Resultat; } function HashVerifieFichier($nAlgo,$sCheminFichier,$sHash,$sClef=null) { F67cfd262(); $sChaine = F8ca52887($sCheminFichier); if ($sChaine === RetourErreur_Entier) { Fdd46bacf(FMK_ChaineConstruit(Fc34ec142("ERR_FICHIER_INEXISTANT"),$sCheminFichier)); return ''; } $Resultat = F4f3897a1($nAlgo,$sChaine,$sClef); if ($Resultat===false) { Fe81a7f9e('ERR_HASH_BAD_CONSTANT',$nAlgo,'FCT_HASHVERIFIEFICHIER'); } return ($Resultat == $sHash); } function F4f3897a1($nAlgo,$sChaine,$sClef=null) { $pclHasheur =& FMK_HASH(); return $pclHasheur->Fb4468e0c($nAlgo,$sChaine,$sClef); } class FMK_FormulaireHTTP { var $m_clTabParam; var $m_clTabFichier; var $m_bPrepareEnvoi; var $m_nTailleEnvoi; var $m_cszContentType; var $m_cszBoundary; function FMK_FormulaireHTTP($sNom) { $this->m_clTabParam = array(); $this->m_pszNom=$sNom; $this->m_bPrepareEnvoi=false; $this->m_nTailleEnvoi=0; } function Fc4e6f842() { for( $i=count($this->m_clTabParam,COUNT_NORMAL)-1; $i>=0; --$i) { unset($this->m_clTabParam[$i]); } $this->m_clTabParam = array(); for( $i=count($this->m_clTabFichier,COUNT_NORMAL)-1; $i>=0; --$i) { unset($this->m_clTabFichier[$i]); } $this->m_clTabFichier = array(); $this->m_bPrepareEnvoi=false; $this->m_nTailleEnvoi=0; } function F8c1bb78a($pszNomParametre, $pszNomFichier, $pszTypeFichier) { if (isset($this->m_clTabParam[$pszNomParametre])) { unset($this->m_clTabParam[$pszNomParametre]); } if (!isset($this->m_clTabFichier[$pszNomParametre])) { $pclFichier=new FMK_ParametreFichier($pszNomParametre,$pszTypeFichier); $this->m_clTabFichier[$pszNomParametre] =& $pclFichier; } else { $pclFichier=&$this->m_clTabFichier[$pszNomParametre]; } if(!$pclFichier->F550bd892($pszNomFichier)) { unset($this->m_clTabFichier[$pszNomParametre]); return false; } return true; } function Fe422991d($pszNomParametre,$pbyVal) { if (isset($this->m_clTabFichier[$pszNomParametre])) { unset($this->m_clTabFichier[$pszNomParametre]); } $this->m_clTabParam[$pszNomParametre] = $pbyVal; } function Fda5af900($pszContentTypeParametre) { $this->m_nTailleEnvoi=0; if(''==$pszContentTypeParametre) $this->m_cszContentType = 'multipart/form-data'; else $this->m_cszContentType = $pszContentTypeParametre; $this->m_cszContentType.=' boundary='; $this->m_cszBoundary = 'WDFormBoundary'; $this->m_cszContentType.=$this->m_cszBoundary; $nTailleBoundary=utf8_strlen($this->m_cszBoundary); $nTailleDisposition=utf8_strlen('Content-Disposition: form-data; name=""' . RC . RC ); $nTailleContentTypeFichier=utf8_strlen('Content-Type: ' . RC); $nTailleDispositionFichier=utf8_strlen('Content-Disposition: form-data; name=""; filename=""' . RC); foreach ($this->m_clTabParam as $cszNom => $clVal) { $this->m_nTailleEnvoi+=$nTailleBoundary+6; $this->m_nTailleEnvoi+=$nTailleDisposition; $this->m_nTailleEnvoi+=utf8_strlen($cszNom); $this->m_nTailleEnvoi+=utf8_strlen($clVal); } foreach ($this->m_clTabFichier as $cszNom => $pclFichier) { $this->m_nTailleEnvoi+=$nTailleBoundary+6; $this->m_nTailleEnvoi+=$nTailleDispositionFichier; $this->m_nTailleEnvoi+=utf8_strlen($pclFichier->m_cszNom); $szFichier = F7816de1e($pclFichier->m_cszNomFichier,fFichierExtension); $this->m_nTailleEnvoi+=utf8_strlen($szFichier); $this->m_nTailleEnvoi+=F53e7b3e7($pclFichier->m_clFichier); if($pclFichier->m_czContentType!=='') { $this->m_nTailleEnvoi+=utf8_strlen($pclFichier->m_czContentType); $this->m_nTailleEnvoi+=$nTailleContentTypeFichier; } $this->m_nTailleEnvoi+=utf8_strlen(RC); } $this->m_nTailleEnvoi+=$nTailleBoundary+6; return $this->m_nTailleEnvoi; } function F067ecf32() { $this->m_nTailleEnvoi=0; $i=0; foreach ($this->m_clTabParam as $cszNom => $clVal) { if($i>0) { $this->m_nTailleEnvoi+=1; } $nTaille = utf8_strlen($cszNom); $this->m_nTailleEnvoi+=$nTaille; if($nTaille>0) { $this->m_nTailleEnvoi+=1; } $nTaille = utf8_strlen($clVal); if($nTaille>0) { $this->m_nTailleEnvoi+=$nTaille; } ++$i; } return $this->m_nTailleEnvoi; } function Fec4f3a50($pszContentTypeParametre) { if(!$this->m_bPrepareEnvoi) $this->Fbdf37d13($pszContentTypeParametre); return $this->m_cszContentType; } function F96848610(&$pclURL ) { if (count($this->m_clTabParam,COUNT_NORMAL)===0) return; $clFormulaire = (utf8_strpos($pclURL,'?')!==false) ? '&' : '?'; $i=0; foreach ($this->m_clTabParam as $cszNom => $clVal) { if($i>0) { $clFormulaire.='&'; } $clFormulaire.= urlencode($cszNom) . '='; if(''!==$clVal) { $clFormulaire.= urlencode($clVal); } ++$i; } $pclURL.=$clFormulaire; } function F5521f638(&$s) { $nSize=0; $cszTemp = ''; $i=0; foreach ($this->m_clTabParam as $cszNom => $clVal) { $cszNomEncode = $cszNom; if($cszNomEncode !== '') { if($i>0) $cszTemp = utf8_sprintf("&%s=", $cszNomEncode); else $cszTemp = utf8_sprintf("%s=", $cszNomEncode); } else { if($i>0) $cszTemp = '&'; } $s .= $cszTemp; $nSize+=utf8_strlen($cszTemp); if('' !== $clVal) { $s .= $clVal; $nSize+=utf8_strlen($clVal); } ++$i; } return $nSize; } function Ffaaa84af(&$s) { $nSize=0; $cszDisposition=("Content-Disposition: form-data; name=\"%s\"") . CRLF . CRLF; $cszDispositionFichier=("Content-Disposition: form-data; name=\"%s\"; filename=\"%s\"") . CRLF; $czContentTypeFichier=("Content-Type: %s") . CRLF; $cszBoundary = utf8_sprintf(CRLF . ("--%s") . CRLF, $this->m_cszBoundary); $cszTemp = $cszTemp2 = ''; foreach ($this->m_clTabParam as $cszNom => $clVal) { $cszTemp = $cszBoundary; $cszTemp2 = utf8_sprintf($cszDisposition,$cszNom); $cszTemp.=$cszTemp2; $s .= $cszTemp; $nSize+=utf8_strlen($cszTemp); $s .= $clVal; $nSize+=utf8_strlen($clVal); } foreach ($this->m_clTabFichier as $cszNom => $pclFichier) { $cszTemp = $cszBoundary; $szFichier = F7816de1e($pclFichier->m_cszNomFichier,fFichierExtension); $cszTemp2 = utf8_sprintf($cszDispositionFichier,$pclFichier->m_cszNom, $szFichier); $cszTemp.=$cszTemp2; if('' !== $pclFichier->m_czContentType) { $cszTemp2 = utf8_sprintf($czContentTypeFichier,$pclFichier->m_czContentType); $cszTemp.=$cszTemp2; } $cszTemp.=CRLF; $s .= $cszTemp; $nSize+=utf8_strlen($cszTemp); $pBuffer = F24f63604($pclFichier->m_clFichier,F53e7b3e7($pclFichier->m_clFichier)); $s .= $pBuffer; $nSize+=utf8_strlen($pBuffer); } $cszEnvoi = utf8_sprintf("\r\n--%s--", $this->m_cszBoundary); $s .= $cszEnvoi; $nSize+=utf8_strlen($cszEnvoi); return $nSize; } function F205d45f5(&$rsRequest) { if(count($this->m_clTabFichier,COUNT_NORMAL)>0) { return $this->Ffaaa84af($rsRequest); } if(utf8_strtolower($this->m_cszContentType) !== 'application/x-www-form-urlencoded') { return $this->F5521f638($rsRequest); } $nSize=0; $cszTemp = ''; $i=0; foreach ($this->m_clTabParam as $cszNom => $clVal) { $cszNomEncode = urlencode($cszNom); $nTailleSortie = utf8_strlen($cszNomEncode); if($nTailleSortie>0) { if($i>0) $cszTemp = utf8_sprintf("&%s=", $cszNomEncode); else $cszTemp = utf8_sprintf("%s=", $cszNomEncode ); } else { if($i>0) $cszTemp = '&'; } $cszEnvoi = $cszTemp; $rsRequest .= $cszEnvoi; $nSize += utf8_strlen($cszEnvoi); if($clVal!=='') { $rsRequest .= $clVal; $nSize += utf8_strlen($clVal); } ++$i; } return $nSize; } function Fbdf37d13($pszContentTypeParametre) { if($this->m_bPrepareEnvoi) return $this->m_nTailleEnvoi; $this->m_bPrepareEnvoi=true; $this->m_nTailleEnvoi=0; if('' == $pszContentTypeParametre) $this->m_cszContentType = 'application/x-www-form-urlencoded'; else $this->m_cszContentType = $pszContentTypeParametre; if(count($this->m_clTabFichier,COUNT_NORMAL)>0) { return $this->Fda5af900($pszContentTypeParametre); } if(utf8_strtolower($this->m_cszContentType) !== 'application/x-www-form-urlencoded') { return $this->F067ecf32(); } $i=0; foreach ($this->m_clTabParam as $cszNom => $clVal) { if($i>0) { $this->m_nTailleEnvoi+=1; } $nTailleSortie = utf8_strlen(urlencode($cszNom)); $this->m_nTailleEnvoi+=$nTailleSortie; if($nTailleSortie>0) { $this->m_nTailleEnvoi+=1; } if($clVal!=='') { $this->m_nTailleEnvoi+=utf8_strlen(urlencode($clVal)); } ++$i; } return $this->m_nTailleEnvoi; } } class FMK_ParametreFichier extends stSTRUCTURE { var $m_cszNom = ''; var $m_cszNomFichier = ''; var $m_czContentType = ''; var $m_clFichier; function F550bd892($pszNomFichier) { Fae814d9e($this->m_clFichier); $this->m_cszNomFichier = $pszNomFichier; $this->m_clFichier = F0a2479f9($pszNomFichier,foLecture); if(RetourErreur_Entier === $this->m_clFichier) { return false; } return true; } } function HTTPAnnuleFormulaire($pszNomFormulaire='FORM') { global $TabVariableGlobaleCOM; if (!isset($TabVariableGlobaleCOM[HTTPFORMULAIRE])) return; $pclTabFormulaire =& $TabVariableGlobaleCOM[HTTPFORMULAIRE]; if(isset($pclTabFormulaire[$pszNomFormulaire])) { unset($pclTabFormulaire[$pszNomFormulaire]); } } function HTTPCreeFormulaire($pszNomFormulaire='FORM') { global $TabVariableGlobaleCOM; if (!isset($TabVariableGlobaleCOM[HTTPFORMULAIRE])) $TabVariableGlobaleCOM[HTTPFORMULAIRE] = array(); $pclTabFormulaire =& $TabVariableGlobaleCOM[HTTPFORMULAIRE]; if(!isset($pclTabFormulaire[$pszNomFormulaire])) { $pclFormulaire = new FMK_FormulaireHTTP($pszNomFormulaire); $pclTabFormulaire[$pclFormulaire->m_pszNom] =& $pclFormulaire; } $pclTabFormulaire[$pszNomFormulaire]->Fc4e6f842(); } function HTTPDestination($pszNomFichier) { F67cfd262(); $clContexte =& F4a1887ce(); $clContexte->F4c8f9bd4('COM_HTTP_Destination',$pszNomFichier); if(false===F7973cde3($pszNomFichier,'')) { Fdd46bacf(FMK_ChaineConstruit(Fc34ec142('ERR_FICHIER_OUVERTURE_IMPOSSIBLE'),$pszNomFichier)); return false; } return true; } function HTTPRAZFormulaire($pszNomFormulaire='FORM') { global $TabVariableGlobaleCOM; if (!isset($TabVariableGlobaleCOM[HTTPFORMULAIRE])) return; $pclTabFormulaire =& $TabVariableGlobaleCOM[HTTPFORMULAIRE]; if(isset($pclTabFormulaire[$pszNomFormulaire])) { $pclTabFormulaire[$pszNomFormulaire]->Fc4e6f842(); } else { Fb9eb0792('ERR_HTTPFORM_NOEXIST', $pszNomFormulaire); } } function HTTPAjouteFichier($pszNomFormulaire, $pszNomParametre, $pszNomFichier, $pszTypeFichier='') { global $TabVariableGlobaleCOM; if (!isset($TabVariableGlobaleCOM[HTTPFORMULAIRE])) return false; $pclTabFormulaire =& $TabVariableGlobaleCOM[HTTPFORMULAIRE]; if(isset($pclTabFormulaire[$pszNomFormulaire])) { return $pclTabFormulaire[$pszNomFormulaire]->F8c1bb78a($pszNomParametre,$pszNomFichier,$pszTypeFichier); } else { Fb9eb0792('ERR_HTTPFORM_NOEXIST', $pszNomFormulaire); } return false; } function HTTPAjouteParametre($pszNomFormulaire, $pszNomParametre, $pstValeur) { global $TabVariableGlobaleCOM; if (!isset($TabVariableGlobaleCOM[HTTPFORMULAIRE])) return false; $pclTabFormulaire =& $TabVariableGlobaleCOM[HTTPFORMULAIRE]; if(isset($pclTabFormulaire[$pszNomFormulaire])) { $pclFormulaire =& $pclTabFormulaire[$pszNomFormulaire]; $pclFormulaire->Fe422991d($pszNomParametre,$pstValeur); } else { Fb9eb0792('ERR_HTTPFORM_NOEXIST', $pszNomFormulaire); } } function HTTPEnvoieFormulaire($pszNomFormulaire, $pszHostName, $pszUserAgent=null, $pszOtherHeaders=null, $pszContentType=null, $pszUser=null, $pszPassWord=null, $nMethode=2) { $bResult=false; global $TabVariableGlobaleCOM; if (!isset($TabVariableGlobaleCOM[HTTPFORMULAIRE])) return false; $pclTabFormulaire =& $TabVariableGlobaleCOM[HTTPFORMULAIRE]; if(isset($pclTabFormulaire[$pszNomFormulaire])) { $pclFormulaire=&$pclTabFormulaire[$pszNomFormulaire]; if($pszUserAgent==null) $pszUserAgent='PC SOFT Framework'; if($pszOtherHeaders==null) $pszOtherHeaders=''; if($pszContentType==null) $pszContentType=''; if($pszUser==null) $pszUser=''; if($pszPassWord==null) $pszPassWord=''; if( (count($pclFormulaire->m_clTabParam,COUNT_NORMAL)===0 && count($pclFormulaire->m_clTabFichier,COUNT_NORMAL)===0) && ($nMethode!==4)&&($nMethode!==1)) { Fb9eb0792('ERR_HTTPFORM_ISEMPTY', $pszNomFormulaire); return false; } if($nMethode===1 && count($pclFormulaire->m_clTabFichier,COUNT_NORMAL)>0) { Fb9eb0792('ERR_HTTPFORM_BADMETHOD'); return false; } $bResult=HTTPRequete($pszHostName,$pszUserAgent,$pszOtherHeaders,$pclFormulaire,$pszContentType,$pszUser,$pszPassWord,$nMethode); $pclFormulaire->Fc4e6f842(); } else { Fb9eb0792('ERR_HTTPFORM_NOEXIST', $pszNomFormulaire); } return $bResult; } ?>